<!DOCTYPE html>
<html lang="es">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Analista</title>
    <?!= include('styles'); ?>
    <style>
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-pendiente { background-color: #fef08a; color: #854d0e; }
        .status-procesado { background-color: #dcfce7; color: #166534; }
        .status-rechazado { background-color: #fee2e2; color: #991b1b; }
        .action-buttons button {
            padding: 6px 12px;
            font-size: 14px;
            margin-left: 8px;
        }
        .card-header-actions {
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div id="notification" class="notification"></div>
    <div id="update-notification" class="notification info">
        Nuevos registros de cobranza disponibles. <a href="#" id="refresh-link">Refrescar Datos.</a>.
    </div>
    <div id="loading-spinner" class="loading-spinner-container"><div class="spinner"></div></div>

    <div class="app-container">
        <header class="app-header">
            <h2>Panel de Analista - Bienvenido, <?!= user.name ?></h2>
            <div class="user-info">
                <span>(<?!= user.email ?> - Rol: <?!= user.role ?>)</span>
                <button id="logout-button" class="button button-danger">Cerrar Sesión</button>
            </div>
        </header>

        <div class="card">
            <header class="card-header">
                <h1>Filtros de Búsqueda</h1>
            </header>
            <main class="card-body">
                <div class="form-grid">
                    <div class="form-grid-item">
                        <label for="filtro-sucursal">Sucursal:</label>
                        <select id="filtro-sucursal" name="filtro-sucursal" disabled>
                            <option value="TODAS">Cargando...</option>
                        </select>
                    </div>
                    <div class="form-grid-item">
                        <label for="filtro-fecha">Fecha:</label>
                        <input type="date" id="filtro-fecha" name="filtro-fecha">
                    </div>
                    <div class="form-grid-item">
                        <label for="filtro-vendedor">Vendedor:</label>
                        <select id="filtro-vendedor" name="filtro-vendedor" disabled>
                            <option value="TODOS">Cargando...</option>
                        </select>
                    </div>
                    <div class="form-grid-item">
                        <label for="filtro-cliente">Cliente:</label>
                        <select id="filtro-cliente" name="filtro-cliente" disabled>
                            <option value="TODOS">Cargando...</option>
                        </select>
                    </div>
                    <div class="form-grid-item">
                        <label for="filtro-banco">Banco Receptor:</label>
                        <select id="filtro-banco" name="filtro-banco" disabled>
                            <option value="TODOS">Cargando...</option>
                        </select>
                    </div>
                    <div class="form-grid-item">
                        <label for="filtro-estado">Estado del Registro:</label>
                        <select id="filtro-estado" name="filtro-estado">
                            <option value="Pendiente" selected>Pendiente</option>
                            <option value="Procesado">Procesado</option>
                            <option value="Rechazado">Rechazado</option>
                            <option value="Todos">Todos</option>
                        </select>
                    </div>
                </div>
            </main>
        </div>

        <div class="card">
            <header class="card-header records-header">
                <h2>Registros de Cobranza</h2>
                <div class="card-header-actions">
                    <button id="download-pdf-btn" class="button button-primary">Descargar PDF</button>
                    <button id="refresh-data-btn" class="button button-secondary">Refrescar Datos</button>
                </div>
            </header>
            <main class="card-body">
                <p id="records-status">Cargando registros...</p>
                <div class="table-container">
                    <table class="records-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Fecha Registro</th>
                                <th>Vendedor</th>
                                <th>Cliente</th>
                                <th>Factura(s)</th>
                                <th>Monto</th>
                                <th>Forma de Pago</th>
                                <th>Banco Emisor</th>
                                <th>Banco Receptor</th>
                                <th>Referencia</th>
                                <th>Fecha Pago</th>
                                <th>Sucursal</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="registros-table-body">
                            <!-- Las filas de registros se cargarán aquí dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </main>
        </div>

        <? if (user.role === 'Admin') { ?>
        <div class="card">
            <header class="card-header">
                <h1>Gestión de Asignaciones Directas (Overrides)</h1>
            </header>
            <main class="card-body">
                <div class="form-grid">
                    <div class="form-grid-item">
                        <label for="override-vendedor">Asignar Vendedor:</label>
                        <select id="override-vendedor" name="override-vendedor"><option>Cargando...</option></select>
                    </div>
                    <div class="form-grid-item">
                        <label for="override-analista">Al Analista:</label>
                        <select id="override-analista" name="override-analista"><option>Cargando...</option></select>
                    </div>
                </div>
                <div class="form-actions">
                    <button id="add-override-btn" class="button button-primary">Crear Regla</button>
                    <button id="refresh-overrides-btn" class="button button-secondary">Refrescar</button>
                </div>
                <hr style="margin: 24px 0; border-color: #e2e8f0;">
                <h3>Reglas Actuales</h3>
                <div class="table-container">
                    <table class="records-table">
                        <thead>
                            <tr>
                                <th>Vendedor</th>
                                <th>Analista Asignado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="override-rules-table-body">
                            <!-- Las reglas se cargarán aquí -->
                        </tbody>
                    </table>
                </div>
            </main>
        </div>
        <? } ?>

    </div>

    <!-- Modal para Rechazo -->
    <div id="rejection-modal" class="modal">
        <div class="modal-content">
            <h3>Motivo del Rechazo</h3>
            <p>Por favor, ingrese el motivo por el cual se rechaza este registro.</p>
            <textarea id="rejection-reason" rows="4" style="width: 100%; margin-top: 10px;" placeholder="Ej: El número de referencia no coincide..."></textarea>
            <div class="modal-buttons">
                <button id="cancel-rejection-btn" class="button button-secondary">Cancelar</button>
                <button id="confirm-rejection-btn" class="button button-danger">Confirmar Rechazo</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación Genérico -->
    <div id="confirm-action-modal" class="modal">
        <div class="modal-content modal-content-small">
            <h3 id="confirm-modal-title">Confirmar Acción</h3>
            <p id="confirm-modal-text">¿Está seguro?</p>
            <div class="modal-buttons">
                <button id="cancel-confirm-btn" class="button button-secondary">Cancelar</button>
                <button id="confirm-action-btn" class="button button-primary">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        const webAppUrl = "<?!= url ?>";
        let sessionToken = localStorage.getItem('sessionToken') || "<?!= token ?>";
        const user = JSON.parse('<?= JSON.stringify(user) ?>');
        let currentRecordsForPDF = []; // Variable para almacenar los registros filtrados para el PDF

        const ui = {
            notification: document.getElementById('notification'),
            loadingSpinner: document.getElementById('loading-spinner'),
            recordsStatus: document.getElementById('records-status'),
            tableBody: document.getElementById('registros-table-body'),
            filterStatus: document.getElementById('filtro-estado'),
            filterBranch: document.getElementById('filtro-sucursal'),
            filterDate: document.getElementById('filtro-fecha'),
            filterVendedor: document.getElementById('filtro-vendedor'),
            filterCliente: document.getElementById('filtro-cliente'),
            filterBanco: document.getElementById('filtro-banco'),
            refreshBtn: document.getElementById('refresh-data-btn'),
            logoutButton: document.getElementById('logout-button'),
            downloadPdfBtn: document.getElementById('download-pdf-btn'),
            toggleLoading(show) { this.loadingSpinner.style.display = show ? 'flex' : 'none'; },
            showNotification(message, type = 'success') { 
                this.notification.textContent = message;
                this.notification.className = `notification ${type}`;
                this.notification.classList.add('visible');
                setTimeout(() => this.notification.classList.remove('visible'), 4000); 
            }
        };

        const rejectionModal = document.getElementById('rejection-modal');
        const confirmActionModal = document.getElementById('confirm-action-modal');
        const confirmRejectionBtn = document.getElementById('confirm-rejection-btn');
        const cancelRejectionBtn = document.getElementById('cancel-rejection-btn');
        const rejectionReasonText = document.getElementById('rejection-reason');
        let currentIdentifierForRejection = null;

        function openRejectionModal(identifier) {
            currentIdentifierForRejection = identifier;
            rejectionModal.style.display = 'flex';
        }
        function closeRejectionModal() {
            rejectionModal.style.display = 'none';
            rejectionReasonText.value = '';
            currentIdentifierForRejection = null;
        }

        const confirmActionBtn = document.getElementById('confirm-action-btn');
        const cancelConfirmBtn = document.getElementById('cancel-confirm-btn');
        const confirmModalText = document.getElementById('confirm-modal-text');
        let onConfirmCallback = null;

        function showConfirmModal(message, onConfirm) {
            confirmModalText.textContent = message;
            onConfirmCallback = onConfirm;
            confirmActionModal.style.display = 'flex';
        }
        function closeConfirmModal() {
            confirmActionModal.style.display = 'none';
            onConfirmCallback = null;
        }

        const DB_NAME = 'AnalystData';
        const DB_VERSION = 1;
        const OBJECT_STORE_NAME = 'records';
        let db;

        function openDB() {
            if (db) return Promise.resolve(db);
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = (event) => reject('Error al abrir IndexedDB: ' + event.target.error);
                request.onupgradeneeded = (event) => {
                    const tempDb = event.target.result;
                    if (!tempDb.objectStoreNames.contains(OBJECT_STORE_NAME)) {
                        tempDb.createObjectStore(OBJECT_STORE_NAME, { keyPath: 'recordIdentifier' });
                    }
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
            });
        }

        async function saveRecordsToDB(records) {
            if (!records) return;
            const db = await openDB();
            const transaction = db.transaction(OBJECT_STORE_NAME, 'readwrite');
            const store = transaction.objectStore(OBJECT_STORE_NAME);
            store.clear();
            records.forEach(record => store.put(record));
            return new Promise((resolve, reject) => {
                transaction.oncomplete = () => resolve();
                transaction.onerror = (event) => reject('Error al guardar en DB: ' + event.target.error);
            });
        }

        async function getRecordsFromDB() {
            const db = await openDB();
            const transaction = db.transaction(OBJECT_STORE_NAME, 'readonly');
            const store = transaction.objectStore(OBJECT_STORE_NAME);
            const request = store.getAll();
            return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject('Error al leer de DB: ' + event.target.error);
            });
        }

        function runGoogleScript(funcName, ...args) {
            return new Promise((resolve, reject) => {
                google.script.run.withSuccessHandler(resolve).withFailureHandler(reject)[funcName](...args);
            });
        }

        function renderTable(records) {
            ui.tableBody.innerHTML = '';
            currentRecordsForPDF = []; // Limpiar antes de renderizar

            if (!records || records.length === 0) {
                ui.recordsStatus.textContent = 'No se encontraron registros.';
                ui.recordsStatus.style.display = 'block';
                return;
            }
            ui.recordsStatus.style.display = 'none';

            const filters = {
                status: ui.filterStatus.value,
                branch: ui.filterBranch.value,
                date: ui.filterDate.value,
                vendedor: ui.filterVendedor.value,
                cliente: ui.filterCliente.value,
                banco: ui.filterBanco.value
            };
            const filteredRecords = records.filter(record => {
                const statusVal = record.EstadoRegistro || 'Pendiente';
                const sucursalVal = record.Sucursal;
                const vendedorVal = record.Vendedor;
                const clienteVal = record['Nombre Cliente'];
                const bancoVal = record['Banco Receptor'];
                const fechaVal = record.Timestamp ? new Date(record.Timestamp).toISOString().split('T')[0] : '';

                const statusMatch = (filters.status === 'Todos' || statusVal === filters.status);
                const branchMatch = (filters.branch === 'TODAS' || sucursalVal === filters.branch);
                const dateMatch = (filters.date === '' || fechaVal === filters.date);
                const vendedorMatch = (filters.vendedor === 'TODOS' || vendedorVal === filters.vendedor);
                const clienteMatch = (filters.cliente === 'TODOS' || clienteVal === filters.cliente);
                const bancoMatch = (filters.banco === 'TODOS' || bancoVal === filters.banco);

                return statusMatch && branchMatch && dateMatch && vendedorMatch && clienteMatch && bancoMatch;
            });

            if (filteredRecords.length === 0) {
                ui.recordsStatus.textContent = 'No se encontraron registros con los filtros seleccionados.';
                ui.recordsStatus.style.display = 'block';
                return;
            }

            currentRecordsForPDF = filteredRecords; // Almacenar los registros filtrados

            filteredRecords.forEach(record => {
                const tr = document.createElement('tr');
                const monto = typeof record['Monto Pagado'] === 'number' ? record['Monto Pagado'].toLocaleString('es-VE', { minimumFractionDigits: 2 }) : record['Monto Pagado'];
                const fechaRegistro = record.Timestamp ? new Date(record.Timestamp).toLocaleDateString('es-VE') : 'N/A';
                const fechaPago = record['Fecha de la Transferencia o Pago'] ? new Date(record['Fecha de la Transferencia o Pago']).toLocaleDateString('es-VE') : 'N/A';
                const estadoClass = `status-${String(record.EstadoRegistro || 'pendiente').toLowerCase()}`;
                const dropdownId = `dropdown-${record.recordIdentifier.replace(/[^a-zA-Z0-9]/g, '-')}`;

                let dropdownItemsHtml = '';
                if (record.EstadoRegistro === 'Pendiente') {
                    dropdownItemsHtml = `
                        <button class="dropdown-item btn-process" data-identifier='${record.recordIdentifier}' title="Marcar este registro como Procesado">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"></path></svg>
                            <span>Procesar</span>
                        </button>
                        <button class="dropdown-item btn-reject" data-identifier='${record.recordIdentifier}' title="Rechazar este registro">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
                            <span>Rechazar</span>
                        </button>
                    `;
                } else {
                    dropdownItemsHtml = `
                        <button class="dropdown-item btn-reopen" data-identifier='${record.recordIdentifier}' title="Revertir este registro al estado Pendiente">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"></path></svg>
                            <span>Reabrir</span>
                        </button>
                    `;
                }

                tr.innerHTML = `
                    <td data-label="ID">${record['ID Registro'] || 'N/A'}</td>
                    <td data-label="Fecha Registro">${fechaRegistro}</td>
                    <td data-label="Vendedor">${record.Vendedor || 'N/A'}</td>
                    <td data-label="Cliente">${record['Nombre Cliente'] || 'N/A'}</td>
                    <td data-label="Factura(s)">${record.Factura || 'N/A'}</td>
                    <td data-label="Monto">${monto}</td>
                    <td data-label="Forma de Pago">${record['Forma de Pago'] || 'N/A'}</td>
                    <td data-label="Banco Emisor">${record['Banco Emisor'] || 'N/A'}</td>
                    <td data-label="Banco Receptor">${record['Banco Receptor'] || 'N/A'}</td>
                    <td data-label="Referencia">${record['Nro. de Referencia'] || 'N/A'}</td>
                    <td data-label="Fecha Pago">${fechaPago}</td>
                    <td data-label="Sucursal">${record.Sucursal || 'N/A'}</td>
                    <td data-label="Estado"><span class="status-badge ${estadoClass}">${record.EstadoRegistro || 'Pendiente'}</span></td>
                    <td data-label="Acciones" class="action-buttons">
                        <div class="actions-menu-container">
                            <button class="kebab-button" title="Más opciones" data-dropdown-id="${dropdownId}">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg>
                            </button>
                            <div class="actions-dropdown" id="${dropdownId}">
                                ${dropdownItemsHtml}
                            </div>
                        </div>
                    </td>
                `;
                ui.tableBody.appendChild(tr);
            });
        }

        async function loadRecords(forceRefresh = false) {
            ui.toggleLoading(true);
            ui.recordsStatus.textContent = 'Cargando registros...';
            
            if (!forceRefresh) {
                try {
                    const cachedRecords = await getRecordsFromDB();
                    if (cachedRecords && cachedRecords.length > 0) {
                        renderTable(cachedRecords);
                        ui.recordsStatus.textContent = 'Buscando actualizaciones...';
                    } else {
                        ui.recordsStatus.textContent = 'No hay datos locales. Buscando en el servidor...';
                    }
                } catch (error) {
                    console.error('Error al leer de IndexedDB:', error);
                    ui.recordsStatus.textContent = 'Error en caché local. Buscando en el servidor...';
                }
            }

            try {
                const freshRecords = await runGoogleScript('getRecordsForAnalyst', sessionToken, { status: 'Todos', branch: 'TODAS' });
                await saveRecordsToDB(freshRecords);
                renderTable(freshRecords);
                ui.showNotification('Datos actualizados desde el servidor.', 'success');
            } catch (error) {
                ui.recordsStatus.textContent = `Error al cargar registros: ${error.message}`;
                ui.showNotification(`Error al cargar: ${error.message}`, 'error');
            } finally {
                ui.toggleLoading(false);
            }
        }

        async function handleAction(identifier, newStatus, comment = null) {
            ui.toggleLoading(true);
            try {
                const result = await runGoogleScript('updateRecordStatus', sessionToken, identifier, newStatus, comment);
                ui.showNotification(result, 'success');
                await loadRecords(true);
            } catch (error) {
                ui.showNotification(`Error: ${error.message}`, 'error');
                ui.toggleLoading(false);
            }
        }

        async function populateBranchFilter() {
            try {
                const branches = await runGoogleScript('getSucursalesDisponibles', sessionToken);
                ui.filterBranch.innerHTML = '<option value="TODAS">Todas las sucursales</option>';
                if (branches && branches.length > 0) {
                    branches.forEach(branch => {
                        ui.filterBranch.innerHTML += `<option value="${branch}">${branch}</option>`;
                    });
                    ui.filterBranch.disabled = false;
                } else {
                     ui.filterBranch.innerHTML += '<option value="NINGUNA">No hay sucursales</option>';
                }
            } catch (error) {
                ui.showNotification('Error al cargar sucursales: ' + error.message, 'error');
                ui.filterBranch.innerHTML = '<option value="TODAS">Error al cargar</option>';
            }
        }

        async function populateVendedorFilter() {
            try {
                const vendedores = await runGoogleScript('getVendedoresDisponibles', sessionToken);
                ui.filterVendedor.innerHTML = '<option value="TODOS">Todos los vendedores</option>';
                if (vendedores && vendedores.length > 0) {
                    vendedores.forEach(vendedor => {
                        ui.filterVendedor.innerHTML += `<option value="${vendedor}">${vendedor}</option>`;
                    });
                    ui.filterVendedor.disabled = false;
                } else {
                     ui.filterVendedor.innerHTML += '<option value="NINGUNO">No hay vendedores</option>';
                }
            } catch (error) {
                ui.showNotification('Error al cargar vendedores: ' + error.message, 'error');
                ui.filterVendedor.innerHTML = '<option value="TODOS">Error al cargar</option>';
            }
        }

        async function populateClienteFilter() {
            try {
                const clientes = await runGoogleScript('getClientesDisponibles', sessionToken);
                ui.filterCliente.innerHTML = '<option value="TODOS">Todos los clientes</option>';
                if (clientes && clientes.length > 0) {
                    clientes.forEach(cliente => {
                        ui.filterCliente.innerHTML += `<option value="${cliente}">${cliente}</option>`;
                    });
                    ui.filterCliente.disabled = false;
                } else {
                     ui.filterCliente.innerHTML += '<option value="NINGUNO">No hay clientes</option>';
                }
            } catch (error) {
                ui.showNotification('Error al cargar clientes: ' + error.message, 'error');
                ui.filterCliente.innerHTML = '<option value="TODOS">Error al cargar</option>';
            }
        }

        async function populateBancoReceptorFilter() {
            try {
                const bancos = await runGoogleScript('getBancosReceptoresDisponibles', sessionToken);
                ui.filterBanco.innerHTML = '<option value="TODOS">Todos los bancos</option>';
                if (bancos && bancos.length > 0) {
                    bancos.forEach(banco => {
                        ui.filterBanco.innerHTML += `<option value="${banco}">${banco}</option>`;
                    });
                    ui.filterBanco.disabled = false;
                } else {
                     ui.filterBanco.innerHTML += '<option value="NINGUNO">No hay bancos</option>';
                }
            } catch (error) {
                ui.showNotification('Error al cargar bancos: ' + error.message, 'error');
                ui.filterBanco.innerHTML = '<option value="TODOS">Error al cargar</option>';
            }
        }
        
        let clientTimestamp = new Date().getTime().toString();

        function pollForUpdates() {
            setInterval(async () => {
                try {
                    const result = await runGoogleScript('checkForUpdates', sessionToken, clientTimestamp);
                    if (result.newUpdates) {
                        const notificationElement = document.getElementById('update-notification');
                        notificationElement.classList.add('visible');
                        clientTimestamp = result.serverTimestamp;
                    }
                } catch (error) {
                    console.error('Error polling for updates:', error);
                }
            }, 30000); // <--- AÑADIDO: Ejecutar cada 30 segundos
        }

        function descargarAnalisisPDF() {
            ui.toggleLoading(true);
            ui.showNotification('Generando PDF, por favor espere...', 'info');
            ui.downloadPdfBtn.disabled = true;

            // Recopilar los filtros actuales de la UI
            const filters = {
                status: ui.filterStatus.value,
                branch: ui.filterBranch.value,
                // Añadimos los otros filtros que getRecordsForAnalyst espera
                // Aunque no se usen en la UI de filtros principal, los pasamos para consistencia
                date: ui.filterDate.value, 
                vendedor: ui.filterVendedor.value,
                cliente: ui.filterCliente.value,
                banco: ui.filterBanco.value
            };

            google.script.run
                .withSuccessHandler(onPdfSuccess)
                .withFailureHandler(onPdfFailure)
                .exportarVistaFiltradaPDF(sessionToken, filters);
        }

        function onPdfSuccess(response) {
            const link = document.createElement('a');
            link.href = 'data:application/pdf;base64,' + response.base64;
            link.download = response.filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            ui.showNotification('La descarga del PDF ha comenzado.', 'success');
            ui.toggleLoading(false);
            ui.downloadPdfBtn.disabled = false;
        }

        function onPdfFailure(error) {
            ui.showNotification('Error al generar el PDF: ' + error.message, 'error');
            ui.toggleLoading(false);
            ui.downloadPdfBtn.disabled = false;
        }

        function setupEventListeners() {
            ui.downloadPdfBtn.addEventListener('click', descargarAnalisisPDF);

            document.getElementById('refresh-link').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('update-notification').classList.remove('visible');
                loadRecords(true);
            });

            ui.logoutButton.addEventListener('click', () => {
                localStorage.removeItem('sessionToken');
                window.top.location.href = webAppUrl;
            });

            ui.refreshBtn.addEventListener('click', () => loadRecords(true));
            ui.filterStatus.addEventListener('change', async () => renderTable(await getRecordsFromDB()));
            ui.filterBranch.addEventListener('change', async () => renderTable(await getRecordsFromDB()));
            ui.filterDate.addEventListener('change', async () => renderTable(await getRecordsFromDB()));
            ui.filterVendedor.addEventListener('change', async () => renderTable(await getRecordsFromDB()));
            ui.filterCliente.addEventListener('change', async () => renderTable(await getRecordsFromDB()));
            ui.filterBanco.addEventListener('change', async () => renderTable(await getRecordsFromDB()));
            
            ui.tableBody.addEventListener('click', (event) => {
                const kebabButton = event.target.closest('.kebab-button');
                if (kebabButton) {
                    const dropdownId = kebabButton.dataset.dropdownId;
                    const dropdown = document.getElementById(dropdownId);
                    if (!dropdown) return;

                    const isVisible = dropdown.classList.contains('visible');
                    document.querySelectorAll('.actions-dropdown.visible').forEach(d => d.classList.remove('visible'));

                    if (!isVisible) {
                        document.body.appendChild(dropdown);
                        const rect = kebabButton.getBoundingClientRect();
                        dropdown.style.top = `${rect.bottom}px`;
                        dropdown.style.left = `${rect.left - dropdown.offsetWidth + rect.width}px`;
                        dropdown.classList.add('visible');
                    }
                }
            });

            document.addEventListener('click', (event) => {
                const target = event.target;
                const actionButton = target.closest('.dropdown-item');
                const visibleDropdown = document.querySelector('.actions-dropdown.visible');

                if (actionButton) {
                    if (visibleDropdown) visibleDropdown.classList.remove('visible');
                    
                    const identifier = actionButton.dataset.identifier;
                    if (!identifier) return;

                    if (actionButton.classList.contains('btn-process')) {
                        showConfirmModal('¿Está seguro de que desea marcar este registro como "Procesado"?', () => {
                            handleAction(identifier, 'Procesado');
                        });
                    }
                    if (actionButton.classList.contains('btn-reject')) {
                        openRejectionModal(identifier);
                    }
                    if (actionButton.classList.contains('btn-reopen')) {
                        showConfirmModal('¿Está seguro de que desea reabrir este registro y devolverlo a "Pendiente"?', () => {
                            handleAction(identifier, 'Pendiente');
                        });
                    }
                    return;
                }

                if (visibleDropdown && !target.closest('.kebab-button')) {
                    visibleDropdown.classList.remove('visible');
                }
            });

            cancelRejectionBtn.addEventListener('click', closeRejectionModal);
            confirmRejectionBtn.addEventListener('click', () => {
                const reason = rejectionReasonText.value.trim();
                if (reason) {
                    handleAction(currentIdentifierForRejection, 'Rechazado', reason);
                    closeRejectionModal();
                } else {
                    ui.showNotification('Debe proporcionar un motivo para rechazar.', 'error');
                }
            });

            cancelConfirmBtn.addEventListener('click', closeConfirmModal);
            confirmActionBtn.addEventListener('click', () => {
                if (typeof onConfirmCallback === 'function') {
                    onConfirmCallback();
                }
                closeConfirmModal();
            });

            window.addEventListener('click', (event) => {
                if (event.target == rejectionModal) closeRejectionModal();
                if (event.target == confirmActionModal) closeConfirmModal();
            });
        }

        async function initializeView() {
            console.log("Vista de Analista cargada para el usuario:", user);
            await openDB();
            setupEventListeners();
            await populateBranchFilter();
            await populateVendedorFilter();
            await populateClienteFilter();
            await populateBancoReceptorFilter();
            await loadRecords();
            pollForUpdates();
            if (user.role === 'Admin') {
                initializeAdminView();
            }
        }

        async function initializeAdminView() {
            const uiAdmin = {
                vendedorSelect: document.getElementById('override-vendedor'),
                analistaSelect: document.getElementById('override-analista'),
                addBtn: document.getElementById('add-override-btn'),
                rulesTableBody: document.getElementById('override-rules-table-body')
            };

            function updateOrAddRuleInTable(rule) {
                const existingRow = uiAdmin.rulesTableBody.querySelector(`[data-seller-code="${rule.sellerCode}"]`);
                if (existingRow) {
                    existingRow.parentElement.parentElement.querySelector('td:nth-child(2)').textContent = rule.analystEmail;
                } else {
                    const tr = document.createElement('tr');
                    const sellerName = uiAdmin.vendedorSelect.options[uiAdmin.vendedorSelect.selectedIndex].text;
                    tr.innerHTML = `
                        <td data-label="Vendedor">${sellerName}</td>
                        <td data-label="Analista Asignado">${rule.analystEmail}</td>
                        <td data-label="Acciones">
                            <button class="button button-danger btn-delete-override" data-seller-code="${rule.sellerCode}">Eliminar</button>
                        </td>
                    `;
                    uiAdmin.rulesTableBody.appendChild(tr);
                }
            }

            async function loadAdminData(forceRefresh = false) {
                ui.toggleLoading(true);
                try {
                    const data = await runGoogleScript('getOverrideData', sessionToken, forceRefresh);
                    uiAdmin.vendedorSelect.innerHTML = data.allSellers.map(s => `<option value="${s.codigo}">${s.nombre}</option>`).join('');
                    uiAdmin.analistaSelect.innerHTML = data.allAnalysts.map(a => `<option value="${a}">${a}</option>`).join('');
                    uiAdmin.rulesTableBody.innerHTML = '';
                    if (data.currentRules.length > 0) {
                        const sellerMap = new Map(data.allSellers.map(s => [s.codigo, s.nombre]));
                        data.currentRules.forEach(rule => {
                            const tr = document.createElement('tr');
                            const sellerName = sellerMap.get(rule.sellerCode) || rule.sellerCode;
                            tr.innerHTML = `
                                <td data-label="Vendedor">${sellerName}</td>
                                <td data-label="Analista Asignado">${rule.analystEmail}</td>
                                <td data-label="Acciones">
                                    <button class="button button-danger btn-delete-override" data-seller-code="${rule.sellerCode}">Eliminar</button>
                                </td>
                            `;
                            uiAdmin.rulesTableBody.appendChild(tr);
                        });
                    }
                } catch (error) {
                    ui.showNotification('Error al cargar datos de admin: ' + error.message, 'error');
                } finally {
                    ui.toggleLoading(false);
                }
            }

            uiAdmin.addBtn.addEventListener('click', async () => {
                const sellerCode = uiAdmin.vendedorSelect.value;
                const analystEmail = uiAdmin.analistaSelect.value;
                if (!sellerCode || !analystEmail) {
                    ui.showNotification('Por favor, seleccione un vendedor y un analista.', 'error');
                    return;
                }
                ui.toggleLoading(true);
                try {
                    const result = await runGoogleScript('addOverrideRule', sessionToken, sellerCode, analystEmail);
                    ui.showNotification(result, 'success');
                    const newRule = { sellerCode, analystEmail };
                    updateOrAddRuleInTable(newRule);
                } catch (error) {
                    ui.showNotification('Error al crear regla: ' + error.message, 'error');
                } finally {
                    ui.toggleLoading(false);
                }
            });

            uiAdmin.rulesTableBody.addEventListener('click', async (event) => {
                if (event.target.classList.contains('btn-delete-override')) {
                    const sellerCode = event.target.dataset.sellerCode;
                    showConfirmModal(`¿Está seguro de que desea eliminar la regla para el vendedor ${sellerCode}?`, async () => {
                        ui.toggleLoading(true);
                        try {
                            const result = await runGoogleScript('deleteOverrideRule', sessionToken, sellerCode);
                            ui.showNotification(result, 'success');
                            event.target.parentElement.parentElement.remove();
                        } catch (error) {
                            ui.showNotification('Error al eliminar regla: ' + error.message, 'error');
                        } finally {
                            ui.toggleLoading(false);
                        }
                    });
                }
            });

            const refreshOverridesBtn = document.getElementById('refresh-overrides-btn');
            if(refreshOverridesBtn) {
                refreshOverridesBtn.addEventListener('click', async () => {
                    await loadAdminData(true);
                });
            }

            await loadAdminData();
        }

        document.addEventListener('DOMContentLoaded', initializeView);
    </script>
</body>
</html>